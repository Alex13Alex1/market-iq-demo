<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Market IQ ‚Äî Super Demo</title>
  <meta name="description" content="A 30-second daily prediction game with live crowd movement, rank shifts, identity evolution, and share cards." />

  <style>
    :root{
      --bg0:#020617; --bg1:#050b1a;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.085);
      --stroke: rgba(255,255,255,.10);
      --text:#e5e7eb; --muted:#94a3b8;
      --cyan:#22d3ee; --cyan2:#0891b2;
      --gold:#fbbf24; --green:#22c55e; --red:#fb7185;
      --shadow: 0 40px 120px rgba(0,0,0,.82);
      --safeT: env(safe-area-inset-top, 0px);
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeL: env(safe-area-inset-left, 0px);
      --safeR: env(safe-area-inset-right, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1000px 700px at 18% 15%, rgba(34,211,238,.16), transparent 60%),
        radial-gradient(900px 650px at 82% 22%, rgba(251,191,36,.12), transparent 55%),
        radial-gradient(900px 650px at 60% 92%, rgba(244,63,94,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(14px + var(--safeT)) calc(12px + var(--safeL)) calc(14px + var(--safeB)) calc(12px + var(--safeR));
    }

    /* Make it feel like a native app on phones */
    .stage{
      width: min(430px, 100%);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .phone{
      width: 100%;
      max-width: 410px;
      border-radius: 34px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow), 0 0 70px rgba(34,211,238,.12);
      overflow:hidden;
      position:relative;
    }

    /* dynamic viewport height without iOS safari jumps */
    .phone{
      height: min(860px, calc(100dvh - 28px));
    }

    @supports not (height: 100dvh){
      .phone{ height: min(860px, calc(100vh - 28px)); }
    }

    /* Backdrop filter is heavy on mobile; keep it soft and gated */
    @supports ((-webkit-backdrop-filter: blur(10px)) or (backdrop-filter: blur(10px))){
      .phone{ -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); }
    }

    .statusbar{
      height: 44px;
      padding: 14px 16px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color: rgba(229,231,235,.80);
      font-size: 12px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--cyan);box-shadow:0 0 18px rgba(34,211,238,.65)}
    .dotGreen{width:8px;height:8px;border-radius:999px;background:var(--green);box-shadow:0 0 16px rgba(34,197,94,.45)}
    .app{
      height: calc(100% - 44px);
      background: linear-gradient(180deg, rgba(2,6,23,.92), rgba(2,6,23,.98));
      position:relative;
    }

    /* top */
    .top{
      padding: 14px 16px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .brand{display:flex; flex-direction:column; gap:6px; min-width:0}
    .logo{
      font-size:11px; letter-spacing:3px; text-transform:uppercase;
      color: rgba(34,211,238,.95);
      white-space:nowrap;
    }
    .tagline{font-size:12px; color: rgba(148,163,184,.92); line-height:1.25}

    .topRight{display:flex; flex-direction:column; gap:8px; align-items:flex-end}
    .topBtns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .topBtn{
      height:34px;
      padding: 0 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: rgba(229,231,235,.92);
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .topBtn.primary{
      background: linear-gradient(135deg, rgba(34,211,238,.95), rgba(8,145,178,.95));
      border-color: rgba(34,211,238,.30);
      color:#041017;
    }
    .topBtn.warn{
      background: linear-gradient(135deg, rgba(251,191,36,.95), rgba(245,158,11,.95));
      border-color: rgba(251,191,36,.25);
      color:#1b1100;
    }

    .miniStats{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .miniCard{
      min-width:112px;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .miniLabel{font-size:10px; color: rgba(148,163,184,.86)}
    .miniValue{margin-top:3px; font-weight:900; font-size: 14px}
    .c{color:var(--cyan)} .g{color:var(--green)} .y{color:var(--gold)} .r{color:var(--red)}

    /* progress */
    .progressWrap{
      padding: 0 16px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .progress{
      flex:1;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .progress > div{
      height:100%; width: 10%;
      background: linear-gradient(90deg, rgba(34,211,238,.95), rgba(34,197,94,.95));
      transition: width .25s ease;
    }
    .stepHint{font-size:11px; color: rgba(148,163,184,.92); white-space:nowrap}

    /* screens */
    .screen{
      position:absolute;
      inset: 140px 0 74px 0; /* below top; above nav */
      overflow:hidden;
      opacity:0;
      transform: translateX(8px);
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .screen.active{opacity:1; transform:translateX(0); pointer-events:auto;}
    .scroll{
      height:100%;
      overflow:auto;
      padding: 10px 16px 14px;
      scrollbar-width:none;
      -webkit-overflow-scrolling: touch;
    }
    .scroll::-webkit-scrollbar{display:none}

    .card{
      border-radius: 24px;
      background: linear-gradient(160deg, rgba(255,255,255,.085), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 60px rgba(0,0,0,.28);
      overflow:hidden;
    }
    .card + .card{margin-top:12px}
    .pad{padding:16px}
    .h1{font-size:18px; font-weight:950; margin:0 0 6px}
    .h2{font-size:12px; letter-spacing:2px; text-transform:uppercase; color: rgba(148,163,184,.85); margin:0 0 10px}
    .p{color: rgba(148,163,184,.92); font-size: 13px; line-height:1.5; margin:0}

    .row{display:flex; gap:10px}
    .col{flex:1}
    .kv{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(255,255,255,.10);
      font-size: 13px;
    }
    .kv:last-child{border-bottom:0}
    .kv .k{color: rgba(229,231,235,.92)}
    .kv .v{color: rgba(148,163,184,.95); font-weight: 900}

    .chipRow{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(229,231,235,.92);
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.10);
    }
    .chip.cyan{border-color: rgba(34,211,238,.24); background: rgba(34,211,238,.08)}
    .chip.gold{border-color: rgba(251,191,36,.22); background: rgba(251,191,36,.10)}
    .chip.green{border-color: rgba(34,197,94,.22); background: rgba(34,197,94,.10)}
    .chip.red{border-color: rgba(244,63,94,.22); background: rgba(244,63,94,.10)}
    .chip.live{border-color: rgba(34,197,94,.26); background: rgba(34,197,94,.08)}

    /* hero */
    .hero{
      padding: 16px;
      background:
        radial-gradient(680px 380px at 15% 12%, rgba(34,211,238,.14), transparent 62%),
        radial-gradient(680px 380px at 85% 18%, rgba(251,191,36,.11), transparent 60%),
        rgba(255,255,255,.04);
    }
    .sym{font-size:12px;color: rgba(148,163,184,.92)}
    .price{font-size:34px;font-weight:980; letter-spacing:-.5px; margin-top:4px}
    .spark{
      height: 56px; border-radius: 16px;
      background: linear-gradient(90deg, rgba(34,211,238,.08), rgba(34,197,94,.06), rgba(251,191,36,.08));
      border: 1px solid rgba(255,255,255,.08);
      margin-top: 10px;
      position:relative; overflow:hidden;
    }
    .spark:before{
      content:"";
      position:absolute; inset:-60px -160px;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.10), transparent);
      transform: translateX(-40%);
      animation: shimmer 4.2s linear infinite;
    }
    @keyframes shimmer{ 0%{transform: translateX(-40%)} 100%{transform: translateX(40%)} }

    .context{
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 18px;
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.10);
    }
    .contextTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .ctxTitle{font-size:11px; letter-spacing:2px; text-transform:uppercase; color: rgba(148,163,184,.86)}
    .ctxHint{font-size:11px; color: rgba(148,163,184,.92)}
    .ctxLine{
      font-size: 13px;
      color: rgba(229,231,235,.92);
      line-height: 1.35;
      display:flex;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(255,255,255,.10);
    }
    .ctxLine:last-child{border-bottom:0}
    .ctxEmoji{width:18px; text-align:center}

    .question{padding: 14px 16px; border-top: 1px solid rgba(255,255,255,.06)}
    .qTitle{font-size: 16px; font-weight: 950; line-height:1.25}
    .qMeta{margin-top:8px; display:flex; justify-content:space-between; gap:10px; color: rgba(148,163,184,.92); font-size: 12px}
    .bar{
      height: 10px; border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      overflow:hidden;
      margin-top: 8px;
    }
    .bar > div{
      height:100%;
      width: 63%;
      background: linear-gradient(90deg, rgba(34,211,238,.95), rgba(34,197,94,.95));
      transition: width .25s ease;
    }

    .btnRow{
      padding: 12px 16px 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    button{-webkit-tap-highlight-color: transparent}
    .btn{
      height: 70px;
      border-radius: 18px;
      border: none;
      font-size: 18px;
      font-weight: 980;
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .btn:active{transform: scale(.985)}
    .btn.up{background: linear-gradient(135deg, #22c55e, #16a34a); color:#06100a; box-shadow:0 16px 40px rgba(34,197,94,.18)}
    .btn.down{background: linear-gradient(135deg, #fb7185, #e11d48); color:white; box-shadow:0 16px 40px rgba(244,63,94,.18)}
    .btn.ghost{
      grid-column: 1 / 3;
      height: 46px;
      font-size: 13px;
      font-weight: 950;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(229,231,235,.92);
      box-shadow:none;
    }
    .btn.primarySmall{
      height: 46px;
      font-size: 13px;
      font-weight: 980;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(34,211,238,.95), rgba(251,191,36,.22));
      color:#041017;
      border: 1px solid rgba(34,211,238,.25);
    }

    /* bottom nav */
    .nav{
      position:absolute; left:0; right:0; bottom:0;
      height: 74px;
      display:flex; justify-content:space-around; align-items:center;
      background: rgba(0,0,0,.35);
      border-top: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .nav .item{
      width: 64px;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap: 6px;
      color: rgba(148,163,184,.92);
      font-size: 10px;
      cursor:pointer;
      user-select:none;
    }
    .nav .ico{
      width: 40px; height: 40px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 18px;
    }
    .nav .item.active{color: rgba(229,231,235,.95)}
    .nav .item.active .ico{
      background: linear-gradient(135deg, rgba(34,211,238,.95), rgba(8,145,178,.95));
      border-color: rgba(34,211,238,.30);
      color:#041017;
      box-shadow: 0 14px 40px rgba(34,211,238,.14);
    }

    /* modal */
    .overlay{
      position:absolute; inset:0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      background: rgba(2,6,23,.65);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .overlay.show{display:flex}
    .sheet{
      width:100%;
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 120px rgba(0,0,0,.70);
      overflow:hidden;
    }
    .sheetTop{
      padding: 14px 14px 10px;
      display:flex; justify-content:space-between; gap: 12px;
    }
    .sheetTop h3{margin:0; font-size: 16px}
    .sheetTop p{margin:6px 0 0; font-size: 12px; color: rgba(148,163,184,.92); line-height:1.35}
    .xbtn{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      color: rgba(229,231,235,.92);
      cursor:pointer;
      font-weight: 980;
      user-select:none;
    }
    .sheetGrid{
      padding: 0 14px 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .big{
      padding: 12px;
      border-radius: 18px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.10);
    }
    .big .lab{font-size: 10px; color: rgba(148,163,184,.86)}
    .big .val{margin-top:4px; font-size: 18px; font-weight: 980}
    .sheetActions{
      padding: 0 14px 14px;
      display:flex; gap: 10px;
    }
    .sheetActions .btn.ghost{height:44px; grid-column:auto; flex:1}
    .sheetActions .btn.primarySmall{height:44px; flex:1}

    /* share card chooser */
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tab{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.24);
      font-size: 12px;
      font-weight: 900;
      color: rgba(229,231,235,.92);
      cursor:pointer;
      user-select:none;
    }
    .tab.active{background: rgba(34,211,238,.14); border-color: rgba(34,211,238,.28); color: rgba(229,231,235,.95)}
    .hint{margin-top:10px;font-size:12px;color:rgba(148,163,184,.92)}

    /* Live feed */
    .feed{
      margin-top: 12px;
      border-radius: 18px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .feedTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .feedTitle{font-size:11px; letter-spacing:2px; text-transform:uppercase; color: rgba(148,163,184,.86)}
    .feedRight{font-size:11px; color: rgba(148,163,184,.92)}
    .feedItem{
      padding: 10px 12px;
      font-size: 12px;
      color: rgba(229,231,235,.92);
      border-bottom: 1px dashed rgba(255,255,255,.10);
      display:flex; gap:10px; align-items:flex-start;
    }
    .feedItem:last-child{border-bottom:0}
    .feedTime{color: rgba(148,163,184,.92); min-width:48px}
    .feedTxt b{color: var(--cyan)}
    .feedTxt .warn{color: var(--gold); font-weight:900}
    .feedTxt .good{color: var(--green); font-weight:900}

    /* Identity bar */
    .idBox{
      margin-top: 10px;
      padding: 12px;
      border-radius: 18px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
    }
    .idTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
    .idName{font-weight:950; font-size: 14px;}
    .idSub{font-size:12px; color: rgba(148,163,184,.92); margin-top:2px;}
    .idPct{font-size:12px; color: rgba(148,163,184,.92); white-space:nowrap}
    .idBar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      overflow:hidden;
      margin-top: 10px;
    }
    .idBar > div{
      height:100%;
      width: 20%;
      background: linear-gradient(90deg, rgba(34,211,238,.95), rgba(251,191,36,.80));
      transition: width .25s ease;
    }

    @media (prefers-reduced-motion: reduce){
      .screen, .progress > div, .bar > div, .spark:before, .idBar > div { transition:none !important; animation:none !important; }
    }
  </style>
</head>

<body>
  <div class="stage">
    <div class="phone" id="phone">
      <div class="statusbar">
        <div class="pill"><span class="dot"></span><span id="sbSeason">Season 0</span></div>
        <div class="pill" id="sbReset">Reset in --:--:--</div>
      </div>

      <div class="app">

        <div class="top">
          <div class="brand">
            <div class="logo">MARKET IQ</div>
            <div class="tagline">UP / DOWN ‚Üí status ‚Üí identity ‚Üí creator.</div>
          </div>

          <div class="topRight">
            <div class="topBtns">
              <button class="topBtn primary" id="btnPitch">Pitch mode</button>
              <button class="topBtn" id="btnSound">Sound: OFF</button>
              <button class="topBtn warn" id="btnShareCardTop">Share-card</button>
            </div>
            <div class="miniStats">
              <div class="miniCard">
                <div class="miniLabel">Market IQ</div>
                <div class="miniValue"><span class="c" id="uiIQ">1000</span> ‚Ä¢ <span class="y" id="uiLeague">Bronze</span></div>
              </div>
              <div class="miniCard">
                <div class="miniLabel">Top rank</div>
                <div class="miniValue"><span class="g" id="uiTopPct">60%</span> <span style="color:rgba(148,163,184,.92);">‚Ä¢</span> <span class="y" id="uiType">‚Äî</span></div>
              </div>
            </div>
          </div>
        </div>

        <div class="progressWrap">
          <div class="progress"><div id="uiProg"></div></div>
          <div class="stepHint" id="uiStepHint">Step 1/3</div>
        </div>

        <!-- ONBOARD 1 -->
        <section class="screen active" id="s-on1">
          <div class="scroll">
            <div class="card">
              <div class="pad">
                <div class="h1">Can you beat the crowd today?</div>
                <p class="p">One question. Two buttons. No charts needed.</p>
                <div class="chipRow">
                  <span class="chip cyan">30 seconds/day</span>
                  <span class="chip gold">Leagues & status</span>
                  <span class="chip green">Share to flex</span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="pad">
                <div class="h2>Why people invite friends</div>
                <div class="kv"><span class="k">‚ÄúI beat the crowd‚Äù</span><span class="v y">Status</span></div>
                <div class="kv"><span class="k">Live shifts</span><span class="v c">Drama</span></div>
                <div class="kv"><span class="k">Weekly seasons</span><span class="v y">Fresh start</span></div>
                <button class="btn primarySmall" id="btnOn1">Continue</button>
              </div>
            </div>

            <div class="hint">Swipe left/right. (Pitch mode runs automatically.)</div>
          </div>
        </section>

        <!-- ONBOARD 2 -->
        <section class="screen" id="s-on2">
          <div class="scroll">
            <div class="card">
              <div class="pad">
                <div class="h1">You get an identity (not just a score).</div>
                <p class="p">Your choices shape your archetype: Rebel, Wave Rider, Crowd Shadow‚Ä¶</p>
                <div class="chipRow">
                  <span class="chip cyan">Simple play</span>
                  <span class="chip gold">Deep meaning</span>
                  <span class="chip">Evolves weekly</span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="pad">
                <div class="h2>Endgame</div>
                <div class="kv"><span class="k">Verified Mind</span><span class="v c">Access</span></div>
                <div class="kv"><span class="k">Market Voice</span><span class="v y">Influence</span></div>
                <div class="kv"><span class="k">Signal Creator</span><span class="v g">Monetize</span></div>
                <button class="btn primarySmall" id="btnOn2">Continue</button>
              </div>
            </div>
          </div>
        </section>

        <!-- ONBOARD 3 -->
        <section class="screen" id="s-on3">
          <div class="scroll">
            <div class="card">
              <div class="pad">
                <div class="h1">Daily Battle + Live Drama.</div>
                <p class="p">Crowd shifts all day. Your rank moves. You check because it‚Äôs alive.</p>
                <div class="chipRow">
                  <span class="chip gold">Crowd vs You</span>
                  <span class="chip cyan">Live movement</span>
                  <span class="chip green">Share cards</span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="pad">
                <div class="h2>Ready?</div>
                <div class="kv"><span class="k">Genesis badge</span><span class="v y" id="uiGenesis">ON</span></div>
                <div class="kv"><span class="k">Season reset</span><span class="v">Sunday 23:59</span></div>
                <button class="btn primarySmall" id="btnStartPlay">Start playing</button>
                <button class="btn ghost" id="btnResetAll">Reset demo</button>
              </div>
            </div>
          </div>
        </section>

        <!-- PLAY -->
        <section class="screen" id="s-play">
          <div class="scroll">
            <div class="card">
              <div class="hero">
                <div class="sym" id="qSym">BTC / USD</div>
                <div class="price" id="qPx">$98,500</div>
                <div class="spark" aria-hidden="true"></div>

                <div class="chipRow">
                  <span class="chip live"><span class="dotGreen"></span> LIVE <b id="uiLiveUsers">1,284</b></span>
                  <span class="chip cyan" id="qMode">Daily Pulse</span>
                  <span class="chip">Closes in <b id="qTimer">--:--:--</b></span>
                </div>

                <div class="chipRow" style="margin-top:8px;">
                  <span class="chip gold">Crowd now <b id="qCrowdNow">63%</b> UP</span>
                  <span class="chip">Was <b id="qCrowdWas">63%</b></span>
                  <span class="chip">You rank <b id="uiRankNow">Top 60%</b></span>
                </div>

                <div class="context">
                  <div class="contextTop">
                    <div class="ctxTitle">Context</div>
                    <div class="ctxHint" id="uiPhase">Pre-result: ‚Äî</div>
                  </div>
                  <div id="ctxLines"></div>
                </div>

                <div class="idBox">
                  <div class="idTop">
                    <div>
                      <div class="idName" id="idName">Identity: ‚Äî</div>
                      <div class="idSub" id="idSub">Become a ‚ÄúCrowd Breaker‚Äù by picking against the majority.</div>
                    </div>
                    <div class="idPct" id="idPct">0%</div>
                  </div>
                  <div class="idBar"><div id="idBarFill"></div></div>
                </div>

                <div class="feed">
                  <div class="feedTop">
                    <div class="feedTitle">Live feed</div>
                    <div class="feedRight" id="feedHint">updates all day</div>
                  </div>
                  <div id="feedItems"></div>
                </div>

              </div>

              <div class="question">
                <div class="qTitle" id="qTitle">Will price be higher in 24h?</div>
                <div class="qMeta">
                  <span id="qHorizon">Horizon: 24h</span>
                  <span id="uiRare">Only <b>‚Äî</b> picked your choice</span>
                </div>
                <div class="bar"><div id="qBar"></div></div>
              </div>

              <div class="btnRow">
                <button class="btn up" id="btnUp">‚¨Ü UP</button>
                <button class="btn down" id="btnDown">‚¨á DOWN</button>
                <button class="btn ghost" id="btnNextQ">Next demo question ‚ñ∏</button>
              </div>
            </div>

            <div class="row" style="gap:12px;">
              <div class="card col">
                <div class="pad">
                  <div class="h2">Today</div>
                  <div class="kv"><span class="k">Answered</span><span class="v" id="uiAnswered">0/1</span></div>
                  <div class="kv"><span class="k">Streak</span><span class="v y" id="uiStreak">0</span></div>
                </div>
              </div>
              <div class="card col">
                <div class="pad">
                  <div class="h2">Battle</div>
                  <div class="kv"><span class="k">You</span><span class="v y" id="uiYouScore">0</span></div>
                  <div class="kv"><span class="k">Crowd</span><span class="v c" id="uiCrowdScore">0</span></div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="pad">
                <div class="h2">Simple rule</div>
                <p class="p">Tap UP/DOWN ‚Üí your rank moves all day ‚Üí share the drama.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- RECAP -->
        <section class="screen" id="s-recap">
          <div class="scroll">
            <div class="card">
              <div class="pad">
                <div class="h1">Recap (share this)</div>
                <p class="p">People share status, not analysis.</p>

                <div class="row" style="margin-top:10px;">
                  <div class="card col" style="background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); box-shadow:none;">
                    <div class="pad">
                      <div class="h2">You</div>
                      <div class="miniValue y" style="font-size:18px;" id="recYou">0/1</div>
                      <div class="p" style="margin-top:6px;">Your result today.</div>
                    </div>
                  </div>
                  <div class="card col" style="background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); box-shadow:none;">
                    <div class="pad">
                      <div class="h2">Crowd</div>
                      <div class="miniValue c" style="font-size:18px;" id="recCrowd">0/1</div>
                      <div class="p" style="margin-top:6px;">Majority result.</div>
                    </div>
                  </div>
                </div>

                <div class="chipRow" style="margin-top:10px;">
                  <span class="chip">Top <b id="recTop">‚Äî</b></span>
                  <span class="chip">Streak <b id="recStreak">0</b></span>
                  <span class="chip cyan">IQ <b id="recIQ">1000</b></span>
                  <span class="chip gold">Type <b id="recType">‚Äî</b></span>
                </div>

                <div class="tabs">
                  <div class="tab active" data-card="status">STATUS</div>
                  <div class="tab" data-card="battle">YOU vs CROWD</div>
                  <div class="tab" data-card="streak">STREAK</div>
                </div>

                <div class="row" style="margin-top:12px;">
                  <button class="btn primarySmall col" id="btnShareText">Share text</button>
                  <button class="btn ghost col" id="btnSharePNG">Share-card PNG</button>
                </div>
                <div class="hint" id="shareHint" style="display:none;">Saved / shared ‚úÖ</div>
              </div>
            </div>

            <div class="card">
              <div class="pad">
                <div class="h2">Recent picks (demo)</div>
                <div id="hist"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- LEAGUES -->
        <section class="screen" id="s-leagues">
          <div class="scroll">
            <div class="card">
              <div class="pad">
                <div class="h1">Leagues & Seasons</div>
                <p class="p">Weekly reset keeps it alive. Promotion pressure brings you back.</p>

                <div class="row" style="margin-top:10px;">
                  <div class="card col" style="background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); box-shadow:none;">
                    <div class="pad">
                      <div class="h2">Your league</div>
                      <div class="miniValue y" style="font-size:18px;" id="lgLeague">Bronze</div>
                      <div class="p" style="margin-top:6px;" id="lgPromo">3 pts to promotion</div>
                    </div>
                  </div>
                  <div class="card col" style="background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); box-shadow:none;">
                    <div class="pad">
                      <div class="h2">Reset</div>
                      <div class="miniValue c" style="font-size:18px;" id="lgReset">--:--:--</div>
                      <div class="p" style="margin-top:6px;" id="lgSeason">Season 0</div>
                    </div>
                  </div>
                </div>

                <div class="kv"><span class="k">Genesis badge</span><span class="v y" id="lgGenesis">Enabled</span></div>
                <div class="kv"><span class="k">Verified Mind unlock</span><span class="v c" id="lgVerified">Locked</span></div>
                <div class="kv"><span class="k">Signal Creator unlock</span><span class="v g" id="lgCreator">Locked</span></div>

                <div class="hint">Demo uses device time. No backend.</div>
              </div>
            </div>

            <div class="card">
              <div class="pad">
                <div class="h2>Global leaderboard (demo)</div>
                <div id="lb"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- CROWD -->
        <section class="screen" id="s-crowd">
          <div class="scroll">
            <div class="card">
              <div class="pad">
                <div class="h1">Crowd vs Experts (X machine)</div>
                <p class="p">Copy a post. Create drama. Bring people back.</p>
                <div class="chipRow">
                  <span class="chip cyan">Crowd score <b id="cveCrowd">0</b></span>
                  <span class="chip gold">Experts score <b id="cveExperts">0</b></span>
                </div>
                <div class="kv"><span class="k">Post ready</span><span class="v" id="cveScore">Crowd 0 ‚Äî Experts 0</span></div>
                <button class="btn primarySmall" id="btnHotPost">Copy X post</button>
              </div>
            </div>

            <div class="card">
              <div class="pad">
                <div class="h2>Friends duel (demo)</div>
                <div class="kv"><span class="k">7-day duel</span><span class="v" id="duelState">Inactive</span></div>
                <div class="kv"><span class="k">You</span><span class="v y" id="duelYou">0</span></div>
                <div class="kv"><span class="k">Friend</span><span class="v c" id="duelFriend">0</span></div>
                <button class="btn ghost" id="btnStartDuel">Start demo duel</button>
              </div>
            </div>

            <div class="card">
              <div class="pad">
                <div class="h2>Random reward (dopamine)</div>
                <div class="kv"><span class="k">Mystery drops</span><span class="v y" id="dropState">‚Äî</span></div>
                <p class="p">Sometimes you unlock a tiny bonus. Creates ‚Äúone more check‚Äù.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- PROFILE -->
        <section class="screen" id="s-profile">
          <div class="scroll">
            <div class="card">
              <div class="pad">
                <div class="h1">Your Passport</div>
                <p class="p">Identity + reputation. Built for screenshots.</p>

                <div class="row" style="margin-top:10px;">
                  <div class="card col" style="background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); box-shadow:none;">
                    <div class="pad">
                      <div class="h2">Market IQ</div>
                      <div class="miniValue c" style="font-size:18px;" id="pfIQ">1000</div>
                      <div class="p" style="margin-top:6px;" id="pfLeague">Bronze</div>
                    </div>
                  </div>
                  <div class="card col" style="background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); box-shadow:none;">
                    <div class="pad">
                      <div class="h2">Accuracy</div>
                      <div class="miniValue g" style="font-size:18px;" id="pfAcc">‚Äî</div>
                      <div class="p" style="margin-top:6px;">Last picks</div>
                    </div>
                  </div>
                </div>

                <div class="chipRow" id="pfBadges"></div>
              </div>
            </div>

            <div class="card">
              <div class="pad">
                <div class="h2>Identity evolution</div>
                <div class="kv"><span class="k">Current</span><span class="v y" id="pfType">‚Äî</span></div>
                <div class="kv"><span class="k">Progress</span><span class="v" id="pfProg">0%</span></div>
                <p class="p">Your archetype progress grows when you play and when you check live movement.</p>
              </div>
            </div>

            <div class="card">
              <div class="pad">
                <div class="h2>Path to Creator</div>
                <div class="kv"><span class="k">Eligibility</span><span class="v" id="pfElig">Not yet</span></div>
                <div class="kv"><span class="k">Requirement</span><span class="v">IQ ‚â• 1200 + Streak ‚â• 7</span></div>
                <button class="btn primarySmall" id="btnCreator">Preview Creator</button>
              </div>
            </div>
          </div>
        </section>

        <!-- CREATOR -->
        <section class="screen" id="s-creator">
          <div class="scroll">
            <div class="card">
              <div class="pad">
                <div class="h1">Signal Creator (endgame)</div>
                <p class="p">Monetize reputation. Retail subscribes because history is measurable.</p>

                <div class="kv"><span class="k">Creator status</span><span class="v" id="crStatus">Locked</span></div>
                <div class="kv"><span class="k">Public page</span><span class="v">Signals + track record</span></div>
                <div class="kv"><span class="k">Revenue share</span><span class="v g">Enabled</span></div>

                <div class="card" style="margin-top:12px; background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); box-shadow:none;">
                  <div class="pad">
                    <div class="h2>What retail sees</div>
                    <div class="kv"><span class="k">Accuracy</span><span class="v" id="crAcc">‚Äî</span></div>
                    <div class="kv"><span class="k">Streak</span><span class="v" id="crStreak">0</span></div>
                    <div class="kv"><span class="k">League</span><span class="v" id="crLeague">Bronze</span></div>
                    <div class="kv"><span class="k">Type</span><span class="v y" id="crType">‚Äî</span></div>
                  </div>
                </div>

                <button class="btn ghost" id="btnBackHome">Back to Play</button>
              </div>
            </div>

            <div class="hint">Demo only ‚Äî real product needs verified market data + anti-cheat.</div>
          </div>
        </section>

        <!-- NAV -->
        <div class="nav" id="nav">
          <div class="item" data-go="s-play"><div class="ico">üéÆ</div><div>Play</div></div>
          <div class="item" data-go="s-recap"><div class="ico">üìà</div><div>Recap</div></div>
          <div class="item" data-go="s-leagues"><div class="ico">üèÜ</div><div>Leagues</div></div>
          <div class="item" data-go="s-crowd"><div class="ico">‚öîÔ∏è</div><div>Crowd</div></div>
          <div class="item" data-go="s-profile"><div class="ico">üë§</div><div>You</div></div>
        </div>

        <!-- REWARD MODAL -->
        <div class="overlay" id="overlay">
          <div class="sheet">
            <div class="sheetTop">
              <div>
                <h3 id="rwTitle">Pick submitted ‚úÖ</h3>
                <p id="rwDesc">Instant reward (demo). Live movement continues all day.</p>
              </div>
              <button class="xbtn" id="rwClose">‚úï</button>
            </div>

            <div class="sheetGrid">
              <div class="big">
                <div class="lab">Market IQ</div>
                <div class="val c" id="rwIQ">+12</div>
              </div>
              <div class="big">
                <div class="lab">Streak</div>
                <div class="val y" id="rwStreak">+1</div>
              </div>
              <div class="big">
                <div class="lab">Rank shift</div>
                <div class="val g" id="rwRank">+0</div>
              </div>
              <div class="big">
                <div class="lab">Mystery drop</div>
                <div class="val y" id="rwDrop">‚Äî</div>
              </div>
            </div>

            <div class="sheetActions">
              <button class="btn ghost" id="rwShareText">Share text</button>
              <button class="btn primarySmall" id="rwGoRecap">Go to Recap</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/* ================== State ================== */
const KEY = "market_iq_super_demo_v4_live";
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const todayISO = ()=> new Date().toISOString().slice(0,10);
const $ = (id)=>document.getElementById(id);

const defaultState = () => ({
  season: 0,
  genesis: true,
  iq: 1000,
  streak: 0,
  lastPlayDate: null,
  answeredToday: 0,

  picks: [], // {date,sym,horizon,choice,crowdUpAtPick,crowdUpNow,outcome,correct,crowdCorrect,rarePct}

  battle: { you:0, crowd:0 }, // season
  cve: { crowd:0, experts:0 }, // season
  duel: { active:false, you:0, friend:0 }, // season

  drops: { last:"‚Äî", unlocked:0 },
  sound: false,
  shareCardMode: "status",

  identity: {
    type: "‚Äî",
    target: "Crowd Breaker",
    progress: 0, // 0..100
    evo: [],
    weekStart: "",
    stats: { momentum:0, contrarian:0, crowdFollow:0 }
  },

  live: {
    qId: "",
    crowdNow: 63,
    crowdWas: 63,
    rankNow: 60,   // Top %
    rankWas: 60,
    phase: "‚Äî",
    liveUsers: 1284,
    lastCheckAt: 0,
    feed: [] // {t, msg}
  },

  seasonKey: "" // weekly reset detection
});

let state = load();
function load(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return defaultState();
    return { ...defaultState(), ...JSON.parse(raw) };
  }catch{
    return defaultState();
  }
}
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

/* ================== Weekly season reset (Sunday 23:59 local) ================== */
function getWeekKey(d=new Date()){
  const date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const day = (date.getDay() + 6) % 7; // Monday=0
  date.setDate(date.getDate() - day + 3);
  const firstThursday = new Date(date.getFullYear(),0,4);
  const diff = date - firstThursday;
  const week = 1 + Math.round(diff / 604800000);
  return `${date.getFullYear()}-W${String(week).padStart(2,"0")}`;
}
function weeklyResetIfNeeded(){
  const wk = getWeekKey();
  if(!state.seasonKey){
    state.seasonKey = wk;
    if(!state.identity.weekStart) state.identity.weekStart = wk;
    save(); return;
  }
  if(state.seasonKey !== wk){
    state.season += 1;
    state.seasonKey = wk;
    state.battle = { you:0, crowd:0 };
    state.cve = { crowd:0, experts:0 };
    state.duel = { active:false, you:0, friend:0 };
    state.answeredToday = 0;
    state.drops.last = "‚Äî";
    finalizeWeeklyIdentity(wk);
    // soften identity progress each new week (keeps long-term but resets drama)
    state.identity.progress = Math.floor(state.identity.progress * 0.55);
    state.live.feed = [];
    pushFeed("‚è±Ô∏è", "New season started. Fresh drama.");
    save();
  }
}

/* ================== Reset countdown ================== */
function msToHMS(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const h = String(Math.floor(s/3600)).padStart(2,"0");
  const m = String(Math.floor((s%3600)/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${h}:${m}:${ss}`;
}
function nextSundayEnd(){
  const now = new Date();
  const end = new Date(now);
  const day = now.getDay(); // 0..6 (Sun=0)
  const daysToSunday = (7 - day) % 7;
  end.setDate(now.getDate() + daysToSunday);
  end.setHours(23,59,59,999);
  if(end.getTime() < now.getTime()) end.setDate(end.getDate() + 7);
  return end;
}
function updateResetBadge(){
  const end = nextSundayEnd();
  const ms = end - new Date();
  const txt = "Reset in " + msToHMS(ms);
  const sb = $("sbReset"); if(sb) sb.textContent = txt;
  const lg = $("lgReset"); if(lg) lg.textContent = msToHMS(ms);
}

/* ================== Questions + Context ================== */
const QUESTIONS = [
  { sym:"BTC / USD", px:98500, horizon:"24h", crowdUp:63, title:"Will BTC be higher in 24h?", chance:"58%", mode:"Daily Pulse" },
  { sym:"ETH / USD", px:3420, horizon:"24h", crowdUp:56, title:"Will ETH close higher tomorrow?", chance:"54%", mode:"Daily Pulse" },
  { sym:"NASDAQ / QQQ", px:476, horizon:"7d", crowdUp:48, title:"Will Nasdaq be higher next week?", chance:"52%", mode:"Weekly Pulse" },
  { sym:"GOLD / XAU", px:2340, horizon:"7d", crowdUp:60, title:"Will Gold be higher next week?", chance:"55%", mode:"Weekly Pulse" },
  { sym:"USDJPY", px:148.2, horizon:"48h", crowdUp:51, title:"Will USDJPY be higher in 48h?", chance:"53%", mode:"Daily Pulse" }
];

const CONTEXT_POOL = [
  ["üöÄ","Elon posted a Doge meme"],
  ["üè¶","Fed hinted rates stay higher"],
  ["üìâ","Liquidations spiked in last hour"],
  ["üìà","ETF inflows accelerated today"],
  ["üß†","Sentiment index flipped bullish"],
  ["üßä","Whale moved coins to exchange"],
  ["üß®","Macro data came in hotter than expected"],
  ["üó£Ô∏è","Central bank speech in 2 hours"],
  ["‚ö°","Volatility expanded after breakout"],
  ["üßæ","Large options expiry nearby"]
];

let qIndex = 0;
let currentContext = [];

/* ================== Helpers ================== */
const money = (n)=>{
  const isInt = Math.abs(n) >= 100 || Number.isInteger(n);
  const v = isInt ? Math.round(n).toLocaleString() : n.toFixed(2);
  return "$" + v;
};
function leagueFromIQ(iq){
  if(iq>=1550) return "Legend";
  if(iq>=1400) return "Diamond";
  if(iq>=1250) return "Gold";
  if(iq>=1120) return "Silver";
  return "Bronze";
}
function accuracyLast(n=30){
  const slice = state.picks.slice(0,n);
  if(slice.length===0) return null;
  const ok = slice.filter(p=>p.correct).length;
  return (ok/slice.length)*100;
}
function topPercentApprox(iq){
  if(iq>=1550) return 1;
  if(iq>=1400) return 2;
  if(iq>=1250) return 10;
  if(iq>=1120) return 25;
  return 60;
}
function closeTimerText(){
  const d = new Date();
  const end = new Date(d);
  end.setHours(23,59,59,999);
  const ms = Math.max(0, end-d);
  return msToHMS(ms);
}
function crowdPickFromPct(crowdUp){ return (crowdUp >= 50) ? "UP" : "DOWN"; }
function fmtTop(n){ return `Top ${n}%`; }

/* ================== Live feed ================== */
function timeShort(ts=Date.now()){
  const d = new Date(ts);
  const h = String(d.getHours()).padStart(2,"0");
  const m = String(d.getMinutes()).padStart(2,"0");
  return `${h}:${m}`;
}
function pushFeed(emoji, msg){
  state.live.feed.unshift({ t: Date.now(), msg: `${emoji} ${msg}` });
  state.live.feed = state.live.feed.slice(0, 6);
}

/* ================== Identity ================== */
const ARCHETYPES = [
  { key:"Crowd Breaker", hint:"Pick against the majority.", rule:"contrarian" },
  { key:"Wave Rider", hint:"Ride the majority momentum.", rule:"follow" },
  { key:"Signal Brain", hint:"Balance picks; avoid extremes.", rule:"balanced" }
];

function recomputeIdentity(){
  const last = state.picks.slice(0, 20);
  if(last.length === 0){
    state.identity.type = "Newbie";
    state.identity.target = "Crowd Breaker";
    state.identity.progress = clamp(state.identity.progress, 0, 100);
    return;
  }

  let contra=0, follow=0, mom=0;
  for(let i=0;i<last.length;i++){
    const p = last[i];
    const crowd = crowdPickFromPct(p.crowdUpAtPick ?? p.crowdUp ?? 50);
    if(p.choice !== crowd) contra++;
    else follow++;
    if(i>0 && last[i-1].choice === p.choice) mom++;
  }
  state.identity.stats.momentum = mom;
  state.identity.stats.contrarian = contra;
  state.identity.stats.crowdFollow = follow;

  const total = Math.max(1, contra + follow);
  const contraRate = contra / total;
  const followRate = follow / total;

  let type = "Signal Brain";
  if(contraRate >= 0.62) type = "Crowd Breaker";
  else if(followRate >= 0.62) type = "Wave Rider";

  state.identity.type = type;
  state.identity.target = type;

  // progress grows with behavior + light daily checks (simulated)
  // keep it understandable: 0..100
  const base = clamp(Math.floor((last.length/20)*100), 0, 100);
  const style = (type==="Crowd Breaker") ? Math.floor(contraRate*100) : (type==="Wave Rider") ? Math.floor(followRate*100) : 55;
  const blended = Math.floor((base*0.55) + (style*0.45));
  state.identity.progress = clamp(Math.max(state.identity.progress, blended), 0, 100);
}

function finalizeWeeklyIdentity(newWeekKey){
  recomputeIdentity();
  const type = state.identity.type || "Signal Brain";
  const evo = state.identity.evo || [];
  const prevWeek = state.identity.weekStart || state.seasonKey || getWeekKey();
  if(evo.length===0 || evo[0].week !== prevWeek){
    evo.unshift({ week: prevWeek, type });
    state.identity.evo = evo.slice(0, 8);
  }
  state.identity.weekStart = newWeekKey;
}

/* ================== Minimal sound ================== */
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if(Ctx) audioCtx = new Ctx();
  }
}
function beep(freq=440, dur=0.05, type="sine", gain=0.05){
  if(!state.sound) return;
  ensureAudio();
  if(!audioCtx) return;
  if(audioCtx.state === "suspended"){ audioCtx.resume().catch(()=>{}); }
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = gain;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + dur);
}
function sSwipe(){ beep(520, 0.03, "triangle", 0.03); }
function sPick(){ beep(880, 0.04, "square", 0.03); }
function sWin(){ beep(740, 0.05, "sine", 0.04); setTimeout(()=>beep(980,0.06,"sine",0.04), 70); }

/* ================== Screens & nav ================== */
const screens = ["s-on1","s-on2","s-on3","s-play","s-recap","s-leagues","s-crowd","s-profile","s-creator"];
let current = "s-on1";

function show(id){
  screens.forEach(s=>{
    const el = document.getElementById(s);
    if(el) el.classList.toggle("active", s===id);
  });
  current = id;

  document.querySelectorAll(".nav .item").forEach(i=>{
    i.classList.toggle("active", i.dataset.go===id);
  });

  const onSteps = ["s-on1","s-on2","s-on3"];
  if(onSteps.includes(id)){
    const idx = onSteps.indexOf(id)+1;
    $("uiProg").style.width = (idx/onSteps.length*100) + "%";
    $("uiStepHint").textContent = `Step ${idx}/${onSteps.length}`;
  }else{
    $("uiProg").style.width = "100%";
    $("uiStepHint").textContent = "Ready";
  }

  // a "check" increases identity stickiness a tiny bit (intraday loop)
  onSoftCheck();

  render();
}

document.querySelectorAll(".nav .item").forEach(i=>{
  i.addEventListener("click", ()=>{ beep(520,0.03,"triangle",0.03); show(i.dataset.go); });
});

$("btnOn1").addEventListener("click", ()=>{ beep(520,0.03,"triangle",0.03); show("s-on2"); });
$("btnOn2").addEventListener("click", ()=>{ beep(520,0.03,"triangle",0.03); show("s-on3"); });
$("btnStartPlay").addEventListener("click", ()=>{ beep(520,0.03,"triangle",0.03); show("s-play"); });
$("btnCreator").addEventListener("click", ()=>{ beep(520,0.03,"triangle",0.03); show("s-creator"); });
$("btnBackHome").addEventListener("click", ()=>{ beep(520,0.03,"triangle",0.03); show("s-play"); });

$("btnResetAll").addEventListener("click", ()=>{
  localStorage.removeItem(KEY);
  state = defaultState();
  save();
  qIndex = 0;
  setQuestion(qIndex);
  show("s-on1");
});

/* Swipe */
let touchX = 0;
document.addEventListener("touchstart", (e)=>{ touchX = e.touches[0].clientX; }, {passive:true});
document.addEventListener("touchend", (e)=>{
  const dx = e.changedTouches[0].clientX - touchX;
  if(Math.abs(dx) < 60) return;

  const onOrder = ["s-on1","s-on2","s-on3"];
  const mainOrder = ["s-play","s-recap","s-leagues","s-crowd","s-profile","s-creator"];

  if(onOrder.includes(current)){
    const idx = onOrder.indexOf(current);
    if(dx < 0 && idx < onOrder.length-1){ sSwipe(); show(onOrder[idx+1]); }
    if(dx > 0 && idx > 0){ sSwipe(); show(onOrder[idx-1]); }
    return;
  }
  if(mainOrder.includes(current)){
    const idx = mainOrder.indexOf(current);
    if(dx < 0 && idx < mainOrder.length-1){ sSwipe(); show(mainOrder[idx+1]); }
    if(dx > 0 && idx > 0){ sSwipe(); show(mainOrder[idx-1]); }
  }
}, {passive:true});

/* ================== Pitch mode ================== */
let pitchRunning = false;
let pitchTimer = null;
function stopPitch(){
  pitchRunning = false;
  $("btnPitch").textContent = "Pitch mode";
  if(pitchTimer) clearTimeout(pitchTimer);
  pitchTimer = null;
}
function runPitch(){
  if(pitchRunning){ stopPitch(); return; }
  pitchRunning = true;
  $("btnPitch").textContent = "Stop";
  const seq = ["s-on1","s-on2","s-on3","s-play"];
  let i = 0;
  const step = ()=>{
    if(!pitchRunning) return;
    show(seq[i]);
    i++;
    if(i >= seq.length){ stopPitch(); return; }
    pitchTimer = setTimeout(step, 1300);
  };
  step();
}
$("btnPitch").addEventListener("click", ()=>{ beep(520,0.03,"triangle",0.03); runPitch(); });

/* ================== Sound toggle ================== */
function updateSoundBtn(){
  $("btnSound").textContent = state.sound ? "Sound: ON" : "Sound: OFF";
}
$("btnSound").addEventListener("click", ()=>{
  state.sound = !state.sound;
  save();
  updateSoundBtn();
  if(state.sound){ ensureAudio(); beep(660,0.05,"sine",0.04); }
});

/* ================== Share-card tabs ================== */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    state.shareCardMode = t.dataset.card;
    save();
    beep(520,0.03,"triangle",0.03);
  });
});

/* ================== Context ================== */
function pickContextLines(){
  const a = Math.floor(Math.random() * CONTEXT_POOL.length);
  let b = Math.floor(Math.random() * CONTEXT_POOL.length);
  if(b === a) b = (b + 1) % CONTEXT_POOL.length;
  return [CONTEXT_POOL[a], CONTEXT_POOL[b]];
}
function renderContext(){
  const box = $("ctxLines");
  if(!box) return;
  box.innerHTML = "";
  currentContext.forEach(([emo,text])=>{
    const div = document.createElement("div");
    div.className = "ctxLine";
    div.innerHTML = `<div class="ctxEmoji">${emo}</div><div>${text}</div>`;
    box.appendChild(div);
  });
}

/* ================== Live engine ==================
   - Crowd shifts all day (simulated)
   - Rank shifts all day (simulated)
   - Pre-result phase messages
   - Live users counter
*/
function qKey(q){
  return `${q.sym}|${q.horizon}|${todayISO()}`;
}
function initLiveForQuestion(q){
  const id = qKey(q);
  if(state.live.qId !== id){
    state.live.qId = id;
    state.live.crowdWas = q.crowdUp;
    state.live.crowdNow = q.crowdUp;
    state.live.rankWas = topPercentApprox(state.iq);
    state.live.rankNow = topPercentApprox(state.iq);
    state.live.phase = "‚Äî";
    state.live.feed = [];
    pushFeed("üü¢", "Live day started. Crowd will shift.");
  }
}

function driftCrowd(){
  const q = QUESTIONS[qIndex % QUESTIONS.length];
  initLiveForQuestion(q);

  // drift with small random walk, anchored around original crowdUp
  const anchor = q.crowdUp;
  const now = state.live.crowdNow;
  const step = (Math.random() < 0.5 ? -1 : 1) * (1 + Math.floor(Math.random()*2)); // 1..2
  let next = now + step;

  // pull back toward anchor slowly
  if(Math.random() < 0.35){
    next += (anchor > next) ? 1 : (anchor < next ? -1 : 0);
  }
  next = clamp(next, 35, 75);

  if(next !== now){
    state.live.crowdNow = next;
    // feed only on meaningful changes
    if(Math.abs(next-now) >= 2){
      pushFeed("üë•", `Crowd shifted to <b>${next}%</b> UP`);
    }
  }
}

function driftRank(){
  // rank "moves" based on live checking + IQ + randomness
  const base = topPercentApprox(state.iq);
  let now = state.live.rankNow;

  // small movement
  const nudge = (Math.random() < 0.5 ? -1 : 1) * (Math.random() < 0.7 ? 1 : 2);
  now = clamp(now + nudge, 1, 90);

  // keep around base with gentle pull
  if(Math.random() < 0.50){
    now += (base > now) ? 1 : (base < now ? -1 : 0);
  }
  now = clamp(now, 1, 90);

  const prev = state.live.rankNow;
  state.live.rankNow = now;

  if(now !== prev && Math.abs(now-prev) >= 2){
    const dir = (now < prev) ? "UP" : "DOWN"; // lower top% = better
    pushFeed("üèÜ", `You moved <span class="${dir==="UP"?"good":"warn"}">${dir}</span> to <b>${fmtTop(now)}</b>`);
  }
}

function updatePhase(){
  // pre-result narrative: if user answered today, tension revolves around their pick vs crowd
  const last = state.picks[0];
  if(!last || last.date !== todayISO()){
    // if not answered: streak danger near midnight
    const d = new Date();
    const minsLeft = Math.floor((new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999) - d)/60000);
    if(minsLeft <= 120){
      state.live.phase = "‚ö† Streak in danger. Check before midnight.";
    } else {
      state.live.phase = "Make your pick. Live drama starts.";
    }
    return;
  }

  // answered: build tension relative to crowd movement
  const crowdNow = state.live.crowdNow;
  const crowdPickNow = crowdPickFromPct(crowdNow);
  if(last.choice !== crowdPickNow){
    state.live.phase = "üòà You are against the crowd right now.";
  } else {
    state.live.phase = "üü¢ You are with the crowd right now.";
  }

  // extra spice
  if(Math.random() < 0.18){
    state.live.phase = (Math.random() < 0.5)
      ? "‚ö° Crowd is flipping. Still sure?"
      : "üî• Your pick is holding. Keep watching.";
  }
}

function driftLiveUsers(){
  // simulate active users
  let u = state.live.liveUsers || 1200;
  u += (Math.random()<0.5?-1:1) * (5 + Math.floor(Math.random()*18));
  u = clamp(u, 420, 9900);
  state.live.liveUsers = Math.round(u);
}

function onSoftCheck(){
  // each time user navigates, tiny identity progression
  const now = Date.now();
  if(now - (state.live.lastCheckAt||0) < 25000) return; // no spam
  state.live.lastCheckAt = now;

  // tiny progress bump encourages checking behavior
  const bump = (Math.random() < 0.6) ? 1 : 2;
  state.identity.progress = clamp(state.identity.progress + bump, 0, 100);
  save();
}

/* ================== Question ================== */
function setQuestion(i){
  const q = QUESTIONS[i % QUESTIONS.length];
  initLiveForQuestion(q);

  $("qSym").textContent = q.sym;
  $("qPx").textContent = money(q.px);
  $("qTitle").textContent = q.title;
  $("qHorizon").textContent = `Horizon: ${q.horizon}`;

  // bar shows current crowdNow
  $("qBar").style.width = state.live.crowdNow + "%";
  $("qMode").textContent = q.mode;

  // live crowd
  $("qCrowdNow").textContent = state.live.crowdNow + "%";
  $("qCrowdWas").textContent = state.live.crowdWas + "%";

  // context
  currentContext = pickContextLines();
  renderContext();

  // rare indicator placeholder
  $("uiRare").innerHTML = `Only <b>‚Äî</b> picked your choice`;

  render();
}
$("btnNextQ").addEventListener("click", ()=>{
  qIndex = (qIndex+1) % QUESTIONS.length;
  setQuestion(qIndex);
  beep(520,0.03,"triangle",0.03);
});

/* ================== Mystery drops ================== */
const DROPS = [
  "üéÅ Bonus insight unlocked",
  "üéÅ +5 Bonus IQ",
  "üéÅ Streak shield",
  "üéÅ ‚ÄúGenesis Spark‚Äù badge",
  "üéÅ Early recap preview"
];
function rollDrop(){
  if(Math.random() > 0.22) return "‚Äî";
  const d = DROPS[Math.floor(Math.random()*DROPS.length)];
  state.drops.unlocked += 1;
  state.drops.last = d;
  return d;
}
// Intraday micro-reward (for checking), low chance
function rollMicroDrop(){
  if(Math.random() > 0.08) return null;
  const d = ["üéÅ Tiny bonus", "üéÅ Extra context", "üéÅ Rank boost"][Math.floor(Math.random()*3)];
  state.drops.unlocked += 1;
  state.drops.last = d;
  pushFeed("üéÅ", `Mystery drop: <b>${d.replace("üéÅ ","")}</b>`);
  return d;
}

/* ================== Outcome simulation ================== */
function simulateOutcome(q){
  const crowdProb = (state.live.crowdNow ?? q.crowdUp) / 100;
  const iqEdge = clamp((state.iq-1000)/3000, -0.08, 0.08);
  const upProb = clamp(crowdProb + iqEdge, 0.35, 0.65);
  return (Math.random() < upProb) ? "UP" : "DOWN";
}
function scorePick(correct){
  const base = 10;
  return correct ? (base + Math.floor(Math.random()*6)) : -(base - 3);
}

/* ================== Rare choice % ================== */
function rarePctFor(choice, crowdNowUp){
  // if crowd is 70% UP, then DOWN is rare=30%
  const up = clamp(crowdNowUp, 5, 95);
  const rare = (choice==="UP") ? up : (100-up);
  // make it feel ‚Äúreal‚Äù: tiny noise
  const noise = (Math.random()<0.5?-1:1) * Math.floor(Math.random()*3); // -2..+2
  return clamp(rare + noise, 5, 95);
}

/* ================== Play ================== */
function play(choice){
  weeklyResetIfNeeded();

  const t = todayISO();
  if(state.lastPlayDate === t){
    showReward("Already played today", "Come back later ‚Äî live crowd movement continues.", 0, 0, 0, "‚Äî");
    return;
  }

  sPick();

  const q = QUESTIONS[qIndex % QUESTIONS.length];
  initLiveForQuestion(q);

  const crowdAtPick = state.live.crowdNow; // capture
  const rare = rarePctFor(choice, crowdAtPick);

  const outcome = simulateOutcome(q);
  const correct = (choice === outcome);

  const delta = scorePick(correct);
  state.iq = Math.max(700, state.iq + delta);

  // streak
  const yesterday = new Date(Date.now()-86400000).toISOString().slice(0,10);
  if(state.lastPlayDate === yesterday) state.streak += 1;
  else state.streak = 1;

  state.lastPlayDate = t;
  state.answeredToday = 1;

  // crowd result (based on crowd at pick, not now)
  const crowdPick = crowdPickFromPct(crowdAtPick);
  const crowdCorrect = (crowdPick === outcome);

  // battle score (season)
  if(correct) state.battle.you += 1;
  if(crowdCorrect) state.battle.crowd += 1;

  // crowd vs experts season score
  const expertPick = (crowdAtPick >= 50) ? "DOWN" : "UP";
  if(outcome === crowdPick) state.cve.crowd += 1;
  if(outcome === expertPick) state.cve.experts += 1;

  // duel
  if(state.duel.active){
    state.duel.you += correct ? 1 : 0;
    state.duel.friend += (Math.random() < 0.52) ? 1 : 0;
  }

  // rank movement on pick (instant dopamine)
  const prevRank = state.live.rankNow;
  // If correct, improve rank; if wrong, worsen slightly (demo feel)
  const rankDelta = correct ? -(2 + Math.floor(Math.random()*3)) : (1 + Math.floor(Math.random()*3));
  state.live.rankNow = clamp(state.live.rankNow + rankDelta, 1, 90);

  // identity progress from pick style
  const contra = (choice !== crowdPick);
  const progGain = contra ? (4 + Math.floor(Math.random()*4)) : (2 + Math.floor(Math.random()*3));
  state.identity.progress = clamp(state.identity.progress + progGain, 0, 100);

  // store pick
  state.picks.unshift({
    date:t,
    sym:q.sym,
    horizon:q.horizon,
    choice,
    crowdUpAtPick:crowdAtPick,
    crowdUpNow:state.live.crowdNow,
    outcome,
    correct,
    crowdCorrect,
    rarePct: rare
  });
  state.picks = state.picks.slice(0, 60);

  // update identity type
  recomputeIdentity();

  // push feed highlights
  pushFeed("üéØ", `You picked <b>${choice}</b>. Only <b>${rare}%</b> did the same.`);
  pushFeed("üë•", `Crowd at pick: <b>${crowdAtPick}%</b> UP`);
  if(state.live.rankNow !== prevRank){
    const dir = (state.live.rankNow < prevRank) ? "UP" : "DOWN";
    pushFeed("üèÜ", `Rank moved <span class="${dir==="UP"?"good":"warn"}">${dir}</span> to <b>${fmtTop(state.live.rankNow)}</b>`);
  }

  // drop
  const drop = rollDrop();
  if(drop !== "‚Äî") pushFeed("üéÅ", `Drop: <b>${drop.replace("üéÅ ","")}</b>`);

  save();

  if(correct) sWin();

  showReward(
    correct ? "Win ‚úÖ" : "Loss ‚ùå",
    `You picked ${choice}. Outcome: ${outcome}. Crowd at pick: ${crowdAtPick}% UP.`,
    delta,
    1,
    (state.live.rankNow - prevRank),
    drop
  );

  // update rare UI
  $("uiRare").innerHTML = `Only <b>${rare}%</b> picked your choice`;
}

$("btnUp").addEventListener("click", ()=> play("UP"));
$("btnDown").addEventListener("click", ()=> play("DOWN"));

/* ================== Reward modal ================== */
function showReward(title, desc, iqDelta, streakDelta, rankDelta, dropText){
  $("rwTitle").textContent = title;
  $("rwDesc").textContent = desc;
  $("rwIQ").textContent = (iqDelta>=0?"+":"") + iqDelta;
  $("rwStreak").textContent = "+" + streakDelta;
  const rd = rankDelta;
  const sign = (rd<=0?"+":""); // lower top% is better, so negative means improvement
  $("rwRank").textContent = `${sign}${rd}`;
  $("rwDrop").textContent = dropText || "‚Äî";
  $("overlay").classList.add("show");
}
function hideReward(){ $("overlay").classList.remove("show"); }
$("rwClose").addEventListener("click", hideReward);
$("rwGoRecap").addEventListener("click", ()=>{ hideReward(); show("s-recap"); });
$("rwShareText").addEventListener("click", async ()=>{ await shareOrCopyText(shareText()); });

/* ================== Share text ================== */
function shareText(){
  const acc = accuracyLast(30);
  const accTxt = acc===null ? "‚Äî" : Math.round(acc) + "%";
  const top = fmtTop(state.live.rankNow || topPercentApprox(state.iq));
  const last = state.picks[0];
  const lastLine = last ? `Crowd: ${last.crowdUpAtPick}% UP ‚Ä¢ I chose ${last.choice} ‚Ä¢ Only ${last.rarePct}% did the same` : "No picks yet";

  return [
    `Market IQ`,
    `I‚Äôm currently ${top} (demo).`,
    `IQ: ${state.iq} (${leagueFromIQ(state.iq)}) ‚Ä¢ Type: ${state.identity.type}`,
    `Streak: ${state.streak} day(s) ‚Ä¢ Accuracy: ${accTxt}`,
    lastLine,
    ``,
    `Can you beat me?`,
    location.href
  ].join("\n");
}
async function shareOrCopyText(text){
  try{
    if(navigator.share){
      await navigator.share({ title:"Market IQ", text, url: location.href });
      return true;
    }
  }catch{}
  try{ await navigator.clipboard.writeText(text); return true; }catch{}
  alert(text);
  return false;
}
$("btnShareText").addEventListener("click", async ()=>{ beep(520,0.03,"triangle",0.03); await shareOrCopyText(shareText()); });

/* ================== Share-card PNG ================== */
function drawRounded(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,x+w,y+h,rr);
  ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr);
  ctx.arcTo(x,y,x+w,y,rr);
  ctx.closePath();
}
function buildCardPayload(mode){
  const acc = accuracyLast(30);
  const d = {
    mode,
    iq: state.iq,
    league: leagueFromIQ(state.iq),
    streak: state.streak,
    top: fmtTop(state.live.rankNow || topPercentApprox(state.iq)),
    acc: acc===null ? "‚Äî" : (Math.round(acc) + "%"),
    type: state.identity.type || "Signal Brain",
    season: state.season,
    battle: { you: state.battle.you, crowd: state.battle.crowd },
    last: state.picks[0] || null
  };
  return d;
}
function cardTitle(mode){
  if(mode==="battle") return "YOU vs CROWD";
  if(mode==="streak") return "STREAK FLEX";
  return "STATUS FLEX";
}
function cardHeadline(d){
  if(d.mode==="battle"){
    const crowdLine = d.last ? `Crowd: ${d.last.crowdUpAtPick}% UP` : "Crowd: ‚Äî";
    const youLine = d.last ? `Me: ${d.last.choice} (only ${d.last.rarePct}%)` : "Me: ‚Äî";
    return [crowdLine, youLine, "Can you beat me?"];
  }
  if(d.mode==="streak"){
    return [`${d.streak}-DAY STREAK`, "Still alive.", "Can you beat me?"];
  }
  return [`I‚Äôm currently ${d.top}`, `IQ ${d.iq} ‚Ä¢ ${d.league}`, `Type: ${d.type}`];
}
async function generateShareCardPNG(mode){
  const d = buildCardPayload(mode);

  const W = 1200, H = 675;
  const canvas = document.createElement("canvas");
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext("2d");

  const g = ctx.createLinearGradient(0,0,W,H);
  g.addColorStop(0, "#020617");
  g.addColorStop(1, "#07102a");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  ctx.globalAlpha = 0.22;
  ctx.fillStyle = "#22d3ee";
  ctx.beginPath(); ctx.ellipse(250,180,220,160,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = "#fbbf24";
  ctx.beginPath(); ctx.ellipse(980,140,240,170,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = "#22c55e";
  ctx.beginPath(); ctx.ellipse(860,560,260,180,0,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha = 1;

  ctx.fillStyle = "rgba(255,255,255,0.06)";
  ctx.strokeStyle = "rgba(255,255,255,0.14)";
  ctx.lineWidth = 2;
  drawRounded(ctx, 60, 70, W-120, H-140, 34);
  ctx.fill(); ctx.stroke();

  ctx.fillStyle = "rgba(34,211,238,0.95)";
  ctx.font = "900 18px ui-sans-serif, system-ui";
  ctx.fillText("MARKET IQ", 110, 135);

  ctx.fillStyle = "rgba(229,231,235,0.92)";
  ctx.font = "950 18px ui-sans-serif, system-ui";
  ctx.fillText(cardTitle(d.mode), 980, 135);

  const lines = cardHeadline(d);
  ctx.fillStyle = "rgba(229,231,235,0.95)";
  ctx.font = "950 48px ui-sans-serif, system-ui";
  ctx.fillText(lines[0], 110, 220);
  ctx.fillText(lines[1], 110, 280);
  ctx.fillText(lines[2], 110, 340);

  const blocks = [
    {k:"Top", v:d.top, c:"#22c55e"},
    {k:"IQ", v:String(d.iq), c:"#22d3ee"},
    {k:"Type", v:d.type, c:"rgba(229,231,235,0.92)"},
    {k:"Accuracy", v:d.acc, c:"#22c55e"},
    {k:"Streak", v:String(d.streak), c:"#fbbf24"},
    {k:"Season", v:String(d.season), c:"rgba(229,231,235,0.92)"}
  ];

  const bx = 110, by = 380, bw = 980, bh = 80, gap = 12;
  const colW = (bw - gap*2)/3;

  function statBox(i, x, y){
    const b = blocks[i];
    ctx.fillStyle = "rgba(0,0,0,0.28)";
    ctx.strokeStyle = "rgba(255,255,255,0.12)";
    ctx.lineWidth = 2;
    drawRounded(ctx, x, y, colW, bh, 22);
    ctx.fill(); ctx.stroke();

    ctx.fillStyle = "rgba(148,163,184,0.92)";
    ctx.font = "900 14px ui-sans-serif, system-ui";
    ctx.fillText(b.k, x+18, y+28);

    ctx.fillStyle = b.c;
    ctx.font = "980 26px ui-sans-serif, system-ui";
    let vv = b.v;
    if(b.k==="Type" && vv.length>18) vv = vv.slice(0,18) + "‚Ä¶";
    ctx.fillText(vv, x+18, y+62);
  }

  statBox(0, bx, by);
  statBox(1, bx+colW+gap, by);
  statBox(2, bx+(colW+gap)*2, by);

  statBox(3, bx, by+bh+gap);
  statBox(4, bx+colW+gap, by+bh+gap);
  statBox(5, bx+(colW+gap)*2, by+bh+gap);

  ctx.fillStyle = "rgba(148,163,184,0.95)";
  ctx.font = "900 16px ui-sans-serif, system-ui";
  const footer = d.last ? `Last: ${d.last.sym} ‚Ä¢ Me: ${d.last.choice} (only ${d.last.rarePct}%)` : "Last: ‚Äî";
  ctx.fillText(footer.length>90 ? footer.slice(0,90)+"‚Ä¶" : footer, 110, 625);

  ctx.fillStyle = "rgba(34,211,238,0.92)";
  ctx.font = "900 16px ui-sans-serif, system-ui";
  ctx.fillText(location.href.replace(/^https?:\/\//,""), 860, 625);

  return new Promise((resolve)=>{
    canvas.toBlob((blob)=> resolve(blob), "image/png", 0.92);
  });
}
async function shareCardPNG(mode){
  const blob = await generateShareCardPNG(mode);
  const file = new File([blob], `market-iq-${mode}.png`, {type:"image/png"});
  try{
    if(navigator.canShare && navigator.canShare({ files:[file] })){
      await navigator.share({ title:"Market IQ", text:"Can you beat me?", files:[file] });
      return true;
    }
  }catch{}
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `market-iq-${mode}.png`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 1500);
  return true;
}
async function shareCardAndHint(){
  beep(520,0.03,"triangle",0.03);
  const mode = state.shareCardMode || "status";
  await shareCardPNG(mode);
  const h = $("shareHint");
  if(h){
    h.style.display = "block";
    setTimeout(()=> h.style.display="none", 1400);
  }
}
$("btnSharePNG").addEventListener("click", shareCardAndHint);
$("btnShareCardTop").addEventListener("click", shareCardAndHint);

/* ================== Crowd post + duel ================== */
$("btnHotPost").addEventListener("click", async ()=>{
  beep(520,0.03,"triangle",0.03);
  const q = QUESTIONS[qIndex % QUESTIONS.length];
  const last = state.picks[0];
  const line = last
    ? `Crowd: ${last.crowdUpAtPick}% UP ‚Ä¢ I chose ${last.choice} (only ${last.rarePct}%)`
    : `Crowd: ${state.live.crowdNow}% UP on ${q.sym}`;
  const text =
`${line}
Rank: ${fmtTop(state.live.rankNow || topPercentApprox(state.iq))}
My IQ: ${state.iq} (${leagueFromIQ(state.iq)}) ‚Ä¢ Type: ${state.identity.type}
${location.href}`;
  try{ await navigator.clipboard.writeText(text); }catch{ alert(text); }
});

$("btnStartDuel").addEventListener("click", ()=>{
  beep(520,0.03,"triangle",0.03);
  state.duel.active = true;
  state.duel.you = 0;
  state.duel.friend = 0;
  pushFeed("‚öîÔ∏è", "Duel started. Beat your friend.");
  save();
  render();
});

/* ================== Render helpers ================== */
function renderFeed(){
  const box = $("feedItems");
  if(!box) return;
  box.innerHTML = "";
  const items = state.live.feed || [];
  if(items.length===0){
    box.innerHTML = `<div class="feedItem"><div class="feedTime">‚Äî</div><div class="feedTxt">No events yet. Crowd will move soon.</div></div>`;
    return;
  }
  items.forEach(it=>{
    box.insertAdjacentHTML("beforeend", `
      <div class="feedItem">
        <div class="feedTime">${timeShort(it.t)}</div>
        <div class="feedTxt">${it.msg}</div>
      </div>
    `);
  });
}

function promoText(){
  // simple promo pressure: closer when your seasonal score increases
  const you = state.battle.you || 0;
  const need = clamp(5 - you, 0, 9);
  return (need===0) ? "Promotion secured ‚úÖ" : `${need} pts to promotion`;
}

/* ================== Render ================== */
function render(){
  weeklyResetIfNeeded();

  // recompute identity occasionally
  recomputeIdentity();

  // header mini stats
  $("uiIQ").textContent = state.iq;
  $("uiLeague").textContent = leagueFromIQ(state.iq);
  $("uiType").textContent = state.identity.type || "‚Äî";
  $("uiGenesis").textContent = state.genesis ? "ON" : "OFF";

  // top %
  $("uiTopPct").textContent = `${state.live.rankNow || topPercentApprox(state.iq)}%`;

  // season badges
  $("sbSeason").textContent = `Season ${state.season}`;
  updateResetBadge();
  updateSoundBtn();

  // live block
  $("uiLiveUsers").textContent = state.live.liveUsers.toLocaleString();
  $("qCrowdNow").textContent = state.live.crowdNow + "%";
  $("qCrowdWas").textContent = state.live.crowdWas + "%";
  $("uiRankNow").textContent = fmtTop(state.live.rankNow || topPercentApprox(state.iq));

  // phase text
  $("uiPhase").textContent = state.live.phase;

  // identity bar
  $("idName").textContent = `Identity: ${state.identity.type || "‚Äî"}`;
  const hint = (state.identity.type==="Crowd Breaker")
    ? "You thrive against the majority."
    : (state.identity.type==="Wave Rider")
      ? "You ride the crowd momentum."
      : "You stay balanced and calm.";
  $("idSub").textContent = hint;
  $("idPct").textContent = `${state.identity.progress || 0}%`;
  $("idBarFill").style.width = clamp(state.identity.progress || 0, 0, 100) + "%";

  // today stats
  $("uiAnswered").textContent = `${state.answeredToday}/1`;
  $("uiStreak").textContent = state.streak;

  // battle scores
  $("uiYouScore").textContent = state.battle.you;
  $("uiCrowdScore").textContent = state.battle.crowd;

  // recap
  const you = state.answeredToday ? (state.picks[0]?.correct ? 1 : 0) : 0;
  const crowd = state.answeredToday ? (state.picks[0]?.crowdCorrect ? 1 : 0) : 0;
  $("recYou").textContent = `${you}/1`;
  $("recCrowd").textContent = `${crowd}/1`;
  $("recTop").textContent = fmtTop(state.live.rankNow || topPercentApprox(state.iq));
  $("recStreak").textContent = state.streak;
  $("recIQ").textContent = state.iq;
  $("recType").textContent = state.identity.type || "‚Äî";

  // history
  const hist = $("hist");
  hist.innerHTML = "";
  const items = state.picks.slice(0, 6);
  if(items.length===0){
    hist.innerHTML = `<div class="kv"><span class="k">No picks yet</span><span class="v">Make a pick on Play</span></div>`;
  }else{
    items.forEach(p=>{
      const badge = p.correct ? `<span class="chip green">‚úÖ</span>` : `<span class="chip red">‚ùå</span>`;
      hist.insertAdjacentHTML("beforeend", `
        <div class="kv">
          <span class="k">${p.sym} ‚Ä¢ ${p.date} ‚Ä¢ You: ${p.choice} (only ${p.rarePct}%) ‚Ä¢ Crowd: ${p.crowdUpAtPick}% UP ‚Ä¢ Outcome: ${p.outcome}</span>
          <span class="v">${badge}</span>
        </div>
      `);
    });
  }

  // leagues
  const verified = (state.iq >= 1250 && state.streak >= 10);
  const creator = (state.iq >= 1200 && state.streak >= 7);

  $("lgLeague").textContent = leagueFromIQ(state.iq);
  $("lgPromo").textContent = promoText();
  $("lgSeason").textContent = `Season ${state.season}`;
  $("lgGenesis").textContent = state.genesis ? "Enabled" : "Disabled";
  $("lgVerified").textContent = verified ? "Unlocked" : "Locked";
  $("lgCreator").textContent = creator ? "Eligible" : "Locked";

  // leaderboard
  const lb = $("lb");
  lb.innerHTML = "";
  const demoLB = [
    {name:"NeoMacro", iq:1820},
    {name:"QuantFox", iq:1650},
    {name:"You", iq:state.iq},
    {name:"CandleKid", iq:1180},
    {name:"RetailPro", iq:1125}
  ].sort((a,b)=>b.iq-a.iq);
  demoLB.forEach((u,i)=>{
    lb.insertAdjacentHTML("beforeend", `
      <div class="kv">
        <span class="k">#${i+1} ${u.name}</span>
        <span class="v">${u.iq} ‚Ä¢ ${leagueFromIQ(u.iq)}</span>
      </div>
    `);
  });

  // crowd vs experts
  $("cveCrowd").textContent = state.cve.crowd;
  $("cveExperts").textContent = state.cve.experts;
  $("cveScore").textContent = `Crowd ${state.cve.crowd} ‚Äî Experts ${state.cve.experts}`;

  // duel
  $("duelState").textContent = state.duel.active ? "Active" : "Inactive";
  $("duelYou").textContent = state.duel.you;
  $("duelFriend").textContent = state.duel.friend;

  // drops
  $("dropState").textContent = state.drops.last || "‚Äî";

  // profile
  $("pfIQ").textContent = state.iq;
  $("pfLeague").textContent = leagueFromIQ(state.iq);
  const acc = accuracyLast(30);
  $("pfAcc").textContent = acc===null ? "‚Äî" : Math.round(acc) + "%";
  $("pfType").textContent = state.identity.type || "‚Äî";
  $("pfProg").textContent = `${state.identity.progress || 0}%`;
  $("pfElig").textContent = creator ? "Eligible ‚úÖ" : "Not yet";

  // badges
  const badges = [];
  if(state.genesis) badges.push({t:"Genesis", cls:"gold"});
  if(state.streak>=7) badges.push({t:"7-day streak", cls:"gold"});
  if(verified) badges.push({t:"Verified Mind", cls:"cyan"});
  if(creator) badges.push({t:"Creator eligible", cls:"green"});
  if(state.drops.unlocked>=1) badges.push({t:"Mystery drop", cls:"gold"});

  const pfBadges = $("pfBadges");
  pfBadges.innerHTML = "";
  if(badges.length===0){
    pfBadges.innerHTML = `<span class="chip">No badges yet</span>`;
  }else{
    badges.forEach(b=> pfBadges.insertAdjacentHTML("beforeend", `<span class="chip ${b.cls}">${b.t}</span>`));
  }

  // creator
  $("crStatus").textContent = creator ? "Eligible ‚úÖ" : "Locked";
  $("crAcc").textContent = acc===null ? "‚Äî" : Math.round(acc) + "%";
  $("crStreak").textContent = state.streak;
  $("crLeague").textContent = leagueFromIQ(state.iq);
  $("crType").textContent = state.identity.type || "‚Äî";

  // feed
  renderFeed();

  // rare indicator if played today
  const last = state.picks[0];
  if(last && last.date===todayISO()){
    $("uiRare").innerHTML = `Only <b>${last.rarePct}%</b> picked your choice`;
  }
}

/* ================== Timer ticks ================== */
function tick1s(){
  const tEl = $("qTimer");
  if(tEl) tEl.textContent = closeTimerText();
  updateResetBadge();
  setTimeout(tick1s, 1000);
}

/* ================== Live tick (intraday loop) ==================
   Slow + safe to avoid mobile lag
*/
function tickLive(){
  weeklyResetIfNeeded();

  driftLiveUsers();

  // crowd/rank drift even if user doesn't act
  if(Math.random() < 0.85) driftCrowd();
  if(Math.random() < 0.65) driftRank();

  // micro reward occasionally
  rollMicroDrop();

  // sometimes simulate friend move (social pressure)
  if(Math.random() < 0.12){
    const names = ["Alex","Mia","Noah","Lena","Max"];
    const n = names[Math.floor(Math.random()*names.length)];
    const p = (Math.random() < 0.5) ? "UP" : "DOWN";
    pushFeed("üë§", `${n} picked <b>${p}</b>`);
  }

  updatePhase();
  save();
  render();

  // 20‚Äì35s feels ‚Äúalive‚Äù without looking fake
  const next = 20000 + Math.floor(Math.random()*15000);
  setTimeout(tickLive, next);
}

/* ================== Init ================== */
weeklyResetIfNeeded();
recomputeIdentity();
updateSoundBtn();

const startQ = QUESTIONS[qIndex % QUESTIONS.length];
initLiveForQuestion(startQ);
setQuestion(qIndex);
save();
render();
tick1s();
tickLive();

/* first-run behavior */
if(state.picks.length > 0 || state.lastPlayDate){
  show("s-play");
}else{
  show("s-on1");
}

/* ================== Share-card mode sync ================== */
(function syncTabs(){
  const mode = state.shareCardMode || "status";
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.card === mode);
  });
})();
</script>
</body>
                    </html>
